{% extends "base.html" %}

{% block title %}Controle Coupole{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/dashboard.css?v=5.0.3">
<style>[x-cloak] { display: none !important; }</style>
{% endblock %}

{% block status_indicator %}
<button id="btn-check-update" class="btn-update-check" title="Verifier les mises a jour">
    <span class="update-check-icon">&#x21BB;</span>
    <span class="update-check-text">MAJ</span>
    <span class="update-badge hidden" id="update-badge">!</span>
</button>
<div class="flex items-center gap-1.5 text-xs font-mono" id="service-status">
    <span class="status-dot"></span>
    <span class="status-text text-obs-text-muted">Connexion...</span>
</div>
{% endblock %}

{% block content %}
<!-- ═══ Main 2-Column Grid ═══ -->
<div x-data class="grid grid-cols-1 lg:grid-cols-[350px_1fr] gap-4 mb-4">

    <!-- ══ Left Column: Compass ══ -->
    <section class="panel panel-astro">
        <h2 class="section-title section-title-fire mb-4">Position Coupole</h2>

        <div class="flex justify-center mb-4">
            <canvas id="compass" width="320" height="320"
                    class="bg-obs-dark rounded-full border-2 border-obs-border"
                    aria-label="Boussole de position coupole"></canvas>
        </div>

        <!-- Timer widget (hidden, legacy) -->
        <div class="timer-widget hidden" id="timer-widget">
            <canvas id="timer-canvas" width="100" height="100"></canvas>
            <span id="timer-seconds">--</span>
        </div>

        <!-- Position Info Grid -->
        <div class="grid grid-cols-2 gap-2 text-xs font-mono">
            <!-- CIMIER -->
            <div class="coupole-item flex justify-between items-center p-2 bg-obs-input rounded-button">
                <label class="text-accent-amber font-bold">CIMIER:</label>
                <span id="dome-position" class="coupole-value font-bold text-accent-amber-light">--&deg;</span>
            </div>
            <!-- CIBLE -->
            <div class="telescope-item flex justify-between items-center p-2 bg-obs-input rounded-button">
                <label class="text-accent-green font-bold">CIBLE &radic;x&sup2;:</label>
                <span id="dome-target" class="telescope-value font-bold text-accent-green">--&deg;</span>
            </div>
            <!-- ENC -->
            <div class="enc-item flex justify-between items-center p-2 bg-obs-input rounded-button border-3 border-obs-border" id="enc-item">
                <label class="font-bold text-obs-text-secondary">ENC:</label>
                <span id="encoder-calibrated" class="font-bold">--&deg;</span>
            </div>
            <!-- MODE -->
            <div class="mode-item flex justify-between items-center p-2 bg-obs-input rounded-button">
                <label class="font-bold">MODE:</label>
                <span id="tracking-mode-indicator" class="mode-value">--</span>
            </div>
            <!-- CORRECTIONS (full width) -->
            <div class="corrections-item col-span-2 flex justify-between items-center p-2 bg-obs-input rounded-button">
                <span class="corrections-left flex items-center gap-1">
                    <label class="text-accent-purple font-bold">CORRECTIONS:</label>
                    <span id="corrections-count" class="corrections-count text-accent-purple font-bold">0</span>
                </span>
                <span class="corrections-right text-obs-text-secondary text-[0.85rem]">
                    Total: <span id="corrections-total" class="corrections-total text-accent-purple font-bold">0.00&deg;</span>
                </span>
            </div>
        </div>
    </section>

    <!-- ══ Right Column: Controls ══ -->
    <section class="flex flex-col gap-4">

        <!-- Suivi d'Objet -->
        <div class="panel panel-astro">
            <h3 class="section-title section-title-fire mb-3">Suivi d'Objet</h3>
            <div class="input-group mb-3">
                <input type="text" id="object-name" class="input-field flex-1"
                       placeholder="Ex: M31, Vega, Jupiter...">
                <button id="btn-search" class="btn btn-secondary">Rechercher</button>
            </div>
            <div id="object-info" class="hidden p-3 bg-obs-input rounded-button mb-3 text-sm">
                <span id="object-coords">--</span>
            </div>
            <div class="button-group">
                <button id="btn-start-tracking" class="btn btn-primary" disabled>
                    D&eacute;marrer le Suivi
                </button>
                <button id="btn-stop-tracking" class="btn btn-danger" disabled>
                    Stopper le suivi
                </button>
            </div>
        </div>

        <!-- Suivi Actif (hidden by default, Alpine.js controlled) -->
        <div id="tracking-info" class="panel panel-astro tracking-active-glow"
             x-show="$store.dashboard.trackingVisible" x-cloak>
            <h3 class="text-accent-green font-display font-semibold text-sm mb-3">Suivi Actif</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Objet</span>
                    <span id="tracking-object" class="info-value">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Azimut</span>
                    <span id="tracking-az" class="info-value">--&deg;</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Altitude</span>
                    <span id="tracking-alt" class="info-value">--&deg;</span>
                </div>
            </div>
        </div>

        <!-- Hidden compat elements for JS -->
        <span id="tracking-mode" class="hidden">--</span>
        <span id="tracking-corrections" class="hidden">0</span>
        <span id="tracking-remaining" class="hidden">--s</span>

        <!-- Controle Manuel -->
        <div class="panel panel-astro">
            <h3 class="section-title section-title-fire mb-3">Contr&ocirc;le Manuel</h3>

            <!-- JOG Buttons -->
            <span class="text-[0.65rem] text-obs-text-muted uppercase tracking-wider mb-1 block">Pas &agrave; pas</span>
            <div class="flex gap-2 mb-1">
                <button id="btn-jog-ccw-10" class="btn btn-jog">-10&deg;</button>
                <button id="btn-jog-ccw-1" class="btn btn-jog">-1&deg;</button>
                <button id="btn-stop" class="btn btn-stop">STOP</button>
                <button id="btn-jog-cw-1" class="btn btn-jog">+1&deg;</button>
                <button id="btn-jog-cw-10" class="btn btn-jog">+10&deg;</button>
            </div>

            <div class="section-divider"></div>

            <!-- Continuous Movement -->
            <span class="text-[0.65rem] text-obs-text-muted uppercase tracking-wider mb-1 block">Continu</span>
            <div class="flex gap-2 mb-1">
                <button id="btn-cont-ccw" class="btn btn-continuous flex-1" data-direction="ccw">&lt; CCW</button>
                <button id="btn-cont-cw" class="btn btn-continuous flex-1" data-direction="cw">CW &gt;</button>
            </div>

            <div class="section-divider"></div>

            <!-- GOTO -->
            <span class="text-[0.65rem] text-obs-text-muted uppercase tracking-wider mb-1 block">Position</span>
            <div class="flex gap-2">
                <input type="number" id="goto-angle" class="input-field flex-1"
                       min="0" max="360" placeholder="Angle (0-360)">
                <button id="btn-goto" class="btn btn-secondary">GOTO</button>
            </div>
        </div>
    </section>
</div>

<!-- ═══ Logs Section ═══ -->
<section x-data class="panel panel-astro">
    <h3 class="section-title section-title-fire mb-3">Journal</h3>
    <div id="logs" class="log-container">
        <template x-for="(entry, index) in $store.dashboard.logs" :key="index">
            <div class="log-entry" :class="entry.type"
                 x-text="'[' + entry.time + '] ' + entry.message"></div>
        </template>
    </div>
</section>

<!-- ═══ Modal GOTO Initial (Alpine.js controlled) ═══ -->
<div id="goto-modal" x-data class="goto-modal"
     x-show="$store.dashboard.gotoModalVisible" x-cloak
     role="dialog" aria-modal="true" aria-label="Deplacement GOTO">
    <div class="goto-modal-content">
        <div class="goto-modal-header">
            <span class="goto-icon">&#x1F3AF;</span>
            <h3>GOTO Initial en cours</h3>
        </div>
        <div class="goto-modal-object">
            <span id="goto-modal-object-name">--</span>
        </div>
        <div class="goto-modal-positions">
            <div class="goto-position goto-start">
                <label id="goto-label-left">D&eacute;part</label>
                <span id="goto-modal-start">--&deg;</span>
            </div>
            <div class="goto-chevrons" id="goto-chevrons">
                <span class="chevron">&rsaquo;</span>
                <span class="chevron">&rsaquo;</span>
                <span class="chevron">&rsaquo;</span>
            </div>
            <div class="goto-position goto-end">
                <label id="goto-label-right">Cible</label>
                <span id="goto-modal-target">--&deg;</span>
            </div>
        </div>
        <div class="goto-modal-current">
            <label>Position actuelle</label>
            <span id="goto-modal-current-pos">--&deg;</span>
        </div>
        <div class="goto-modal-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="goto-progress-fill"></div>
            </div>
            <span class="progress-text" id="goto-progress-text">0%</span>
        </div>
        <div class="goto-modal-delta">
            D&eacute;placement: <span id="goto-modal-delta">--&deg;</span>
        </div>
    </div>
</div>

<!-- ═══ Modal Mise a jour (Alpine.js controlled) ═══ -->
<div id="update-modal" x-data class="update-modal"
     x-show="$store.dashboard.updateModalVisible" x-cloak
     role="dialog" aria-modal="true" aria-label="Mise a jour disponible">
    <div class="update-modal-content">
        <div class="update-modal-header">
            <span class="update-icon">&#x1F504;</span>
            <h3>Mise a jour disponible</h3>
        </div>
        <div class="update-modal-body">
            <div class="update-version-info">
                <div class="version-current">
                    <label>Version actuelle</label>
                    <span id="update-current-version">--</span>
                    <small id="update-current-commit">(--)</small>
                </div>
                <div class="version-arrow">&#x2192;</div>
                <div class="version-new">
                    <label>Nouvelle version</label>
                    <span id="update-new-version">--</span>
                    <small id="update-commits-behind">-- commit(s)</small>
                </div>
            </div>
            <div id="update-commit-messages" class="update-commit-messages hidden">
                <label>Changements:</label>
                <ul id="update-changes-list"></ul>
            </div>
            <div id="update-progress" class="update-progress"
                 x-show="$store.dashboard.updateShowProgress" x-cloak>
                <div class="progress-bar">
                    <div class="progress-fill progress-indeterminate"></div>
                </div>
                <span id="update-progress-text">Mise a jour en cours...</span>
            </div>
            <div id="update-error" class="update-error"
                 x-show="$store.dashboard.updateShowError" x-cloak>
                <span id="update-error-text"></span>
            </div>
        </div>
        <div class="update-modal-footer" id="update-buttons">
            <button id="btn-update-later" class="btn btn-secondary"
                    :disabled="$store.dashboard.updateButtonsDisabled">Plus tard</button>
            <button id="btn-update-now" class="btn btn-primary"
                    :disabled="$store.dashboard.updateButtonsDisabled">Mettre a jour</button>
        </div>
    </div>
</div>
{% endblock %}

{% block footer_extra %}
<span id="last-update" class="text-obs-text-muted">Derni&egrave;re mise &agrave; jour: --</span>
{% endblock %}

{% block extra_js %}
<script src="/static/js/dashboard.js?v=20260222c"></script>
{% endblock %}

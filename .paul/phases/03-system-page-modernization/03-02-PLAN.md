---
phase: 03-system-page-modernization
plan: 02
type: execute
wave: 1
depends_on: ["03-01"]
files_modified:
  - web/templates/system.html
  - web/static/js/system.js
autonomous: false
---

<objective>
## Goal
Introduire Alpine.js comme couche reactive pour le status global, le toggle auto-refresh et les indicateurs de composants, en suivant le pattern Alpine.store bridge etabli en Phase 2.

## Purpose
La page Systeme utilise actuellement du vanilla JS pour tout le DOM update (40+ getElementById, className assignments). Ce plan cree un Alpine.store('system') pour les elements reactifs (status global, auto-refresh, badges composants) tout en preservant le polling vanilla JS et la logique metier existante.

## Output
- `web/templates/system.html` — directives Alpine.js (x-data, x-show, x-text, x-bind)
- `web/static/js/system.js` — pont Alpine.store, simplification des updates DOM
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md

## Prior Work
@.paul/phases/03-system-page-modernization/03-01-SUMMARY.md
- Page migree vers base.html avec Tailwind
- Classes sys-badge, sys-card, ipc-fresh etablies
- Tous IDs DOM preserves

@.paul/phases/02-dashboard-modernization/02-03-SUMMARY.md
- Alpine.store('dashboard') pattern etabli
- Pont vanilla JS → Alpine store

## Source Files
@web/templates/system.html — post 03-01, heritage base.html, sections Tailwind
@web/static/js/system.js — 350 lignes, polling 2s, cacheElements + updates DOM
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Avant modification du template HTML | ○ |

**BLOCKING:** Required skills MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded
</skills>

<acceptance_criteria>

## AC-1: Alpine.store('system') fonctionnel
```gherkin
Given la page Systeme charge
When Alpine.js s'initialise
Then un Alpine.store('system') existe avec:
  - globalHealthy (boolean)
  - globalStatusText (string)
  - autoRefresh (boolean, default true)
  - motorStatus (objet: healthy, statusText, badgeClass)
  - encoderStatus (objet: healthy, statusText, badgeClass)
```

## AC-2: Status global et auto-refresh reactifs
```gherkin
Given le store Alpine system
When les donnees de diagnostic sont recues
Then le status dot change de couleur via x-bind:class (pas className assignment)
And le texte status se met a jour via x-text
And le toggle auto-refresh controle le polling via le store
```

## AC-3: Badges composants reactifs
```gherkin
Given les cards Motor Service et Encoder Daemon
When les donnees de diagnostic sont recues
Then les badges status (OK/STALE/UNAVAILABLE) se mettent a jour via x-text et x-bind:class
And les borders des cards changent via x-bind:class
```

## AC-4: Zero regression fonctionnelle
```gherkin
Given les modifications
When la page Systeme fonctionne
Then le polling 2s continue
And les IPC cards se mettent a jour correctement
And la section Configuration se met a jour correctement
And aucune erreur console
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Creer Alpine.store('system') et migrer status global + auto-refresh + badges</name>
  <files>web/static/js/system.js, web/templates/system.html</files>
  <action>
    **Dans system.js**, au debut du fichier (avant DOMContentLoaded):

    1. Creer le store Alpine.js:
       ```js
       document.addEventListener('alpine:init', () => {
           Alpine.store('system', {
               // Global status
               globalHealthy: null,
               globalStatusText: 'Chargement...',
               // Auto-refresh
               autoRefresh: true,
               // Motor Service
               motor: { healthy: false, badgeText: '--', badgeClass: '', cardClass: '' },
               // Encoder Daemon
               encoder: { healthy: false, badgeText: '--', badgeClass: '', cardClass: '' },
           });
       });
       ```

    2. Modifier `updateGlobalStatus()`:
       - Remplacer les assignments className/textContent par le store:
         `Alpine.store('system').globalHealthy = healthy;`
         `Alpine.store('system').globalStatusText = text;`
       - Supprimer les references a elements.globalStatusDot et elements.globalStatusText

    3. Modifier auto-refresh pour utiliser le store:
       - Dans `setupEventListeners()`, remplacer le listener du toggle par un Alpine watch
       - OU garder le listener mais sync avec le store:
         Le toggle checkbox utilise x-model="$store.system.autoRefresh"
         Le JS observe le store pour start/stop le timer
       - Approche recommandee: garder startAutoRefresh/stopAutoRefresh en vanilla JS,
         mais utiliser Alpine effect pour reagir aux changements du store

    4. Modifier `updateMotorService()`:
       - Mettre a jour le store au lieu du DOM direct:
         ```js
         const store = Alpine.store('system');
         const badgeClass = motor.healthy ? 'sys-badge-ok' : (motor.status === 'stale' ? 'sys-badge-stale' : 'sys-badge-error');
         const cardClass = motor.healthy ? 'sys-card-healthy' : (motor.status === 'stale' ? 'sys-card-stale' : 'sys-card-unhealthy');
         store.motor = {
             healthy: motor.healthy,
             badgeText: motor.healthy ? 'OK' : motor.status.toUpperCase(),
             badgeClass: badgeClass,
             cardClass: cardClass
         };
         ```
       - CONSERVER les getElementById pour les detail-values (mode, position, simulation, file-age)
         car ces champs simples ne beneficient pas d'Alpine reactif

    5. Modifier `updateEncoderDaemon()` — meme approche que motor

    **Dans system.html**:

    1. Ajouter x-data sur le bloc content:
       Wrapper principal dans block content

    2. Status indicator — migrer vers Alpine:
       ```html
       <div class="flex items-center gap-1.5 text-xs font-mono" id="global-status" x-data>
           <span class="sys-status-dot"
                 :class="{ 'healthy': $store.system.globalHealthy === true,
                           'unhealthy': $store.system.globalHealthy === false }"></span>
           <span class="status-text text-obs-text-muted"
                 x-text="$store.system.globalStatusText">Chargement...</span>
       </div>
       ```

    3. Motor Service card — badges reactifs:
       ```html
       <div class="bg-obs-dark rounded-button border border-obs-border p-3 transition-colors duration-200"
            id="motor-card" :class="$store.system.motor.cardClass">
           ...
           <span class="sys-badge" id="motor-status-badge"
                 :class="$store.system.motor.badgeClass"
                 x-text="$store.system.motor.badgeText">--</span>
       ```

    4. Encoder Daemon card — meme approche

    5. Footer auto-refresh toggle — x-model:
       ```html
       <input type="checkbox" id="auto-refresh-toggle"
              x-data x-model="$store.system.autoRefresh"
              class="cursor-pointer accent-accent-amber">
       ```

    6. Ajouter x-cloak la ou necessaire (deja present dans extra_css)

    IMPORTANT: Conserver TOUS les IDs existants
    IMPORTANT: Ne PAS modifier la logique de polling (fetchDiagnostic, REFRESH_INTERVAL)
    IMPORTANT: Ne PAS modifier updateIpcCard ou updateConfig (restent en vanilla JS)
    IMPORTANT: Le store doit etre initialise AVANT DOMContentLoaded (alpine:init se declenche avant)
  </action>
  <verify>
    python -c "
with open('web/templates/system.html') as f:
    content = f.read()
assert 'x-text' in content or 'x-bind' in content or ':class' in content, 'Missing Alpine directives'
assert '\\$store.system' in content, 'Missing store reference'

with open('web/static/js/system.js') as f:
    js = f.read()
assert 'Alpine.store' in js, 'Missing Alpine store'
assert 'alpine:init' in js, 'Missing alpine:init event'
assert 'fetchDiagnostic' in js, 'Missing fetchDiagnostic (regression)'
print('✓ Alpine.js store et directives integres')
"
  </verify>
  <done>AC-1, AC-2, AC-3 satisfaits: store Alpine.js avec status, auto-refresh et badges reactifs</done>
</task>

<task type="auto">
  <name>Task 2: Nettoyer les references DOM obsoletes dans cacheElements</name>
  <files>web/static/js/system.js</files>
  <action>
    Apres la migration vers le store:

    1. Retirer de cacheElements() les references devenues inutiles:
       - globalStatus, globalStatusDot, globalStatusText (geres par Alpine)
       - motorStatusBadge (gere par Alpine x-text + x-bind:class)
       - encoderStatusBadge (idem)
       - autoRefreshToggle (gere par x-model)
       - Garder motorCard et encoderCard seulement si encore references dans le JS

    2. Simplifier setupEventListeners():
       - Retirer le listener du toggle (x-model le remplace)
       - Garder le listener du bouton refresh
       - Ajouter un Alpine.effect ou watcher pour sync autoRefresh → start/stopAutoRefresh

    3. Verifier qu'aucune reference a un element supprime n'est utilisee

    IMPORTANT: Ne pas supprimer les fonctions — uniquement les references DOM devenues inutiles
    IMPORTANT: Garder updateIpcCard et updateConfig intacts
  </action>
  <verify>
    python -c "
with open('web/static/js/system.js') as f:
    js = f.read()
assert 'Alpine.store' in js, 'Missing Alpine store'
assert 'fetchDiagnostic' in js, 'Missing fetchDiagnostic'
assert 'updateIpcCard' in js, 'Missing updateIpcCard'
assert 'updateConfig' in js, 'Missing updateConfig'
assert 'REFRESH_INTERVAL' in js, 'Missing refresh interval'
print('✓ JS nettoye, logique preservee')
"
  </verify>
  <done>AC-4 satisfait: JS nettoye, zero regression</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Page Systeme avec Alpine.js integre:
    - Store reactif pour status global, auto-refresh et badges composants
    - Toggle auto-refresh controle par x-model
    - Badges Motor Service et Encoder Daemon reactifs
    - Polling 2s et sections IPC/Config preserves
  </what-built>
  <how-to-verify>
    1. Lancer: cd web && python manage.py runserver 0.0.0.0:8000
    2. Visiter http://localhost:8000/api/health/system/
    3. Verifier: La page se charge sans erreur console (F12 > Console)
    4. Verifier: Le status global (dot + texte) se met a jour
    5. Verifier: Les badges UNAVAILABLE sont colores (rouge)
    6. Verifier: Decocher auto-refresh arrete le polling (F12 > Network)
    7. Verifier: Recocher auto-refresh reprend le polling
    8. Verifier: Le bouton refresh force un fetch
    9. Verifier: Les IPC cards affichent le JSON
    10. Verifier: La section Configuration affiche les donnees
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- web/templates/base.html (Phase 1)
- web/static/css/tailwind-input.css (Phase 1)
- web/static/css/dashboard.css (Phase 2)
- web/templates/dashboard.html (Phase 2)
- web/static/js/dashboard.js (Phase 2)
- web/templates/session.html (Phase 4)
- core/, services/ (backend)
- web/health/views.py, web/health/urls.py (backend)

## SCOPE LIMITS
- Ce plan migre UNIQUEMENT status global, auto-refresh et badges vers Alpine.js
- Les sections IPC et Configuration restent en vanilla JS (peu de gain reactif)
- Pas de modification du backend/API
- Pas de refactoring des styles CSS inline (Phase 5)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] Page se charge sans erreur console
- [ ] Alpine.store('system') accessible dans la console
- [ ] Status global reactif
- [ ] Toggle auto-refresh fonctionne
- [ ] Badges composants reactifs
- [ ] Polling 2s fonctionnel
- [ ] IPC et Config toujours fonctionnels
- [ ] Verification visuelle approuvee
</verification>

<success_criteria>
- Alpine.store('system') fonctionnel avec status, auto-refresh et badges
- Toggle auto-refresh controle par x-model
- Badges composants reactifs via store
- Zero regression fonctionnelle
- Verification humaine approuvee
</success_criteria>

<output>
After completion, create `.paul/phases/03-system-page-modernization/03-02-SUMMARY.md`
</output>

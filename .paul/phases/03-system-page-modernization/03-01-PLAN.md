---
phase: 03-system-page-modernization
plan: 01
type: execute
wave: 1
depends_on: ["02-03"]
files_modified:
  - web/templates/system.html
  - web/static/js/system.js
autonomous: false
---

<objective>
## Goal
Migrer la page Systeme vers le template de base (base.html) avec heritage Django, convertir les sections Composants et IPC en Tailwind CSS en reutilisant les composants etablis (panel-astro, section-title-fire, etc.), et adapter le JS pour la nouvelle structure.

## Purpose
La page Systeme utilise actuellement un HTML standalone (sans heritage base.html), son propre CSS de 469 lignes avec des variables dupliquees, et un pattern astronomique SVG inline different du dashboard. Ce plan l'aligne sur le design system etabli en Phase 1-2 pour une interface coherente.

## Output
- `web/templates/system.html` — template migre vers base.html, sections Composants + IPC en Tailwind
- `web/static/js/system.js` — JS adapte pour les nouveaux selecteurs/classes
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md

## Prior Work
@.paul/phases/02-dashboard-modernization/02-03-SUMMARY.md
- Alpine.store('dashboard') bridge pattern etabli
- panel-astro, section-title-fire, section-divider reutilisables
- x-cloak pattern pour anti-flash

## Source Files
@web/templates/system.html — 239 lignes, HTML standalone, 3 sections (Composants, IPC, Config)
@web/static/js/system.js — 340 lignes, polling 2s, cache elements DOM, ~10 fonctions
@web/static/css/system.css — 469 lignes, CSS custom avec variables dupliquees, astro-pattern inline
@web/templates/base.html — template de base avec header/nav/footer Tailwind
@web/static/css/dashboard.css — composants reutilisables (.panel-astro, .section-title-fire, etc.)
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Avant modification du template HTML | ○ |

**BLOCKING:** Required skills MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded
</skills>

<acceptance_criteria>

## AC-1: Heritage base.html fonctionnel
```gherkin
Given la page Systeme
When elle est chargee a /api/health/system/
Then elle herite de base.html (header, nav, footer partages avec dashboard)
And le titre de l'onglet est "Diagnostic Systeme"
And la nav montre "Systeme" comme actif
And le style x-cloak est present
```

## AC-2: Section Composants modernisee
```gherkin
Given la section Composants
When les donnees de diagnostic sont recues
Then 2 cards (Motor Service, Encoder Daemon) sont affichees dans un grid responsive
And chaque card utilise panel-astro comme fond
And chaque card a un badge de status colore (vert OK, orange STALE, rouge UNAVAILABLE)
And les detail-rows affichent les valeurs avec font monospace
And les borders changent de couleur selon le status (healthy/stale/unhealthy)
```

## AC-3: Section IPC modernisee
```gherkin
Given la section Fichiers IPC
When les donnees de diagnostic sont recues
Then 3 cards IPC sont affichees dans un grid responsive
And chaque card montre le nom du fichier et un badge de fraicheur colore
And le contenu JSON est affiche en monospace dans un conteneur scrollable
And les couleurs (fresh=vert, stale=orange, missing=rouge) sont coherentes avec le theme
```

## AC-4: JS adapte sans regression
```gherkin
Given le JS systeme
When la page est chargee
Then le polling 2s fonctionne (fetchDiagnostic toutes les 2s)
And les elements DOM sont correctement caches (IDs preserves)
And le bouton refresh fonctionne (spin + fetch)
And le toggle auto-refresh fonctionne
And la page se charge sans erreur console
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Migrer system.html vers base.html et convertir Composants + IPC en Tailwind</name>
  <files>web/templates/system.html</files>
  <action>
    **Remplacer le contenu de system.html par un template heritant de base.html:**

    1. Structure de base:
       ```
       {% extends "base.html" %}
       {% block title %}Diagnostic Systeme{% endblock %}
       {% block extra_css %}
       <style>[x-cloak] { display: none !important; }</style>
       <style>
         /* Styles specifiques systeme non couverts par Tailwind */
         .ipc-content { /* styles pre/code pour JSON */ }
         .status-badge { /* badges status inline */ }
         /* Animations: spin refresh, pulse status */
       </style>
       {% endblock %}
       ```

    2. **Block status_indicator** — meme pattern que dashboard:
       ```html
       {% block status_indicator %}
       <div class="flex items-center gap-1.5 text-xs font-mono" id="global-status">
           <span class="status-dot"></span>
           <span class="status-text text-obs-text-muted">Chargement...</span>
       </div>
       {% endblock %}
       ```

    3. **Block content** — sections Composants et IPC:

       **Section Composants:**
       - Wrapper: `<section class="panel panel-astro mb-4">`
       - Titre: `<h2 class="section-title section-title-fire mb-3">Composants</h2>`
       - Grid 2 colonnes: `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">`
       - Chaque card composant:
         - Container: `<div class="bg-obs-dark rounded-button border border-obs-border p-3" id="motor-card">`
         - Header avec icone + titre + badge status
         - Detail rows avec labels secondaires et valeurs monospace
         - CONSERVER tous les IDs existants: motor-card, motor-status-badge, motor-status, motor-mode, motor-position, motor-simulation, motor-file-age, encoder-card, encoder-status-badge, encoder-status, encoder-angle, encoder-calibrated, encoder-file-age
         - Classes de border pour status: border-accent-green (healthy), border-accent-orange (stale), border-accent-red (unhealthy)

       **Section IPC:**
       - Wrapper: `<section class="panel panel-astro mb-4">`
       - Titre: `<h2 class="section-title section-title-fire mb-3">Fichiers IPC (temps reel)</h2>`
       - Grid 3 colonnes: `<div class="grid grid-cols-1 lg:grid-cols-3 gap-3">`
       - Chaque card IPC:
         - Container: `<div class="bg-obs-dark rounded-button border border-obs-border overflow-hidden">`
         - Header avec filename monospace + badge fraicheur
         - Pre/code pour contenu JSON (scrollable, max-height 100px)
         - CONSERVER tous les IDs: ipc-status-fresh, ipc-status-content, ipc-encoder-fresh, ipc-encoder-content, ipc-command-fresh, ipc-command-content

    4. **Block footer_extra** — bouton refresh + toggle + last-update:
       ```html
       {% block footer_extra %}
       <div class="flex items-center gap-3">
           <span id="last-update" class="text-obs-text-muted">Derniere mise a jour: --</span>
           <button id="btn-refresh" class="text-obs-text-secondary hover:text-obs-text transition-colors" title="Rafraichir">&#x21bb;</button>
           <label class="flex items-center gap-1.5 text-obs-text-muted text-xs cursor-pointer">
               <input type="checkbox" id="auto-refresh-toggle" checked class="cursor-pointer">
               Auto-refresh (2s)
           </label>
       </div>
       {% endblock %}
       ```

    5. **Block extra_js:**
       ```html
       {% block extra_js %}
       <script src="/static/js/system.js?v=20260222a"></script>
       {% endblock %}
       ```

    **IMPORTANT:** La section Configuration sera traitee dans le plan 03-02. Pour ce plan, inclure un placeholder vide ou la section config en HTML minimal sans conversion Tailwind.
    **IMPORTANT:** Conserver TOUS les IDs DOM existants pour compatibilite JS.
    **IMPORTANT:** Ne PAS modifier base.html, dashboard.html, dashboard.css ou tailwind-input.css.
    **IMPORTANT:** Inclure les styles specifiques en inline (dans extra_css) pour:
    - .ipc-content (pre monospace, scrollable, max-height 100px)
    - Badges status (.status-badge.healthy/stale/unhealthy)
    - Animation spin pour bouton refresh
    - Couleurs de border dynamiques pour component cards
  </action>
  <verify>
    python -c "
with open('web/templates/system.html') as f:
    content = f.read()
assert '{% extends' in content and 'base.html' in content, 'Missing base.html inheritance'
assert '{% block content %}' in content, 'Missing content block'
assert 'panel-astro' in content, 'Missing panel-astro class'
assert 'section-title-fire' in content, 'Missing section-title-fire'
assert 'motor-card' in content, 'Missing motor-card ID'
assert 'encoder-card' in content, 'Missing encoder-card ID'
assert 'ipc-status-fresh' in content, 'Missing IPC status fresh ID'
assert 'ipc-command-content' in content, 'Missing IPC command content ID'
assert 'auto-refresh-toggle' in content, 'Missing auto-refresh toggle ID'
print('✓ Template system.html migre correctement')
"
  </verify>
  <done>AC-1, AC-2, AC-3 satisfaits: heritage base.html, sections Composants et IPC en Tailwind</done>
</task>

<task type="auto">
  <name>Task 2: Adapter system.js pour la nouvelle structure HTML</name>
  <files>web/static/js/system.js</files>
  <action>
    Adapter le JS pour fonctionner avec le nouveau template:

    1. **cacheElements():** Verifier que tous les getElementById/querySelector fonctionnent avec les nouveaux selecteurs.
       - Le status global utilise maintenant le pattern de base.html: `#service-status` au lieu de `#global-status` — MAIS la page Systeme a son propre status indicator dans status_indicator block, donc `#global-status` reste valide. Verifier et adapter si necessaire.

    2. **updateGlobalStatus():** Les classes de status dot sont definies dans base.html/tailwind-input.css. Verifier que les classes `healthy`, `unhealthy`, `stale` sur `.status-dot` fonctionnent toujours. Si le nouveau template utilise des classes Tailwind differentes, adapter.

    3. **updateMotorService() / updateEncoderDaemon():** Les classes de border dynamiques doivent correspondre au nouveau template:
       - Remplacer `className = 'component-card ' + statusClass` par les classes appropriees
       - Utiliser classList.remove/add pour ne changer que la classe de border, pas toute la className
       - Classes cibles: `border-accent-green`, `border-accent-orange`, `border-accent-red` (ou les equivalents Tailwind du template)

    4. **updateIpcCard():** Les classes de fraicheur doivent correspondre:
       - Garder le pattern className assignment pour les badges fraicheur
       - S'assurer que les classes CSS inline du template correspondent

    5. **setupEventListeners():** Le bouton refresh et toggle restent les memes IDs, pas de changement necessaire.

    6. **Supprimer:** Aucune suppression de logique — uniquement adapter les noms de classes CSS si necessaires.

    IMPORTANT: Ne PAS modifier la logique metier (fetchDiagnostic, updateConfig, formatAge, etc.)
    IMPORTANT: Tester que les IDs references dans cacheElements correspondent au nouveau template
  </action>
  <verify>
    python -c "
with open('web/static/js/system.js') as f:
    js = f.read()
assert 'fetchDiagnostic' in js, 'Missing fetchDiagnostic function'
assert 'cacheElements' in js, 'Missing cacheElements function'
assert 'updateMotorService' in js, 'Missing updateMotorService function'
assert 'updateIpcCard' in js, 'Missing updateIpcCard function'
assert 'REFRESH_INTERVAL' in js, 'Missing refresh interval constant'
print('✓ system.js adapte, logique preservee')
"
  </verify>
  <done>AC-4 satisfait: JS adapte sans regression</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Page Systeme modernisee:
    - Heritage base.html (header, nav, footer partages)
    - Section Composants avec 2 cards panel-astro
    - Section IPC avec 3 cards et badges fraicheur
    - Polling 2s fonctionnel
    - Toggle auto-refresh et bouton refresh
  </what-built>
  <how-to-verify>
    1. Lancer: cd web && python manage.py runserver 0.0.0.0:8000
    2. Visiter http://localhost:8000/api/health/system/
    3. Verifier: La page utilise le meme header/nav/footer que le dashboard
    4. Verifier: La nav montre "Systeme" comme actif
    5. Verifier: Les 2 cards composants ont le fond etoile panel-astro
    6. Verifier: Les 3 cards IPC affichent le contenu JSON
    7. Verifier: Les badges de status sont colores (vert/orange/rouge)
    8. Verifier: Le polling 2s fonctionne (verifier dans F12 > Network)
    9. Verifier: Le bouton refresh et le toggle auto-refresh fonctionnent
    10. Verifier: Pas d'erreur dans la console (F12 > Console)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- web/templates/base.html (Phase 1)
- web/static/css/tailwind-input.css (Phase 1)
- web/static/css/dashboard.css (Phase 2)
- web/static/img/constellations-pattern.svg (Phase 2)
- web/templates/dashboard.html (Phase 2)
- web/static/js/dashboard.js (Phase 2)
- web/templates/session.html (Phase 4)
- core/, services/ (backend)
- web/health/views.py (backend API — pas de changement)

## SCOPE LIMITS
- Ce plan migre UNIQUEMENT les sections Composants et IPC
- La section Configuration sera traitee dans le plan 03-02
- Le CSS system.css ne sera PAS supprime dans ce plan (sera fait en 03-02 ou Phase 5)
- Pas de migration vers Alpine.js dans ce plan (polling vanilla JS conserve)
- Pas de modification du backend/API

</boundaries>

<verification>
Before declaring plan complete:
- [ ] Page se charge sans erreur console
- [ ] Heritage base.html fonctionne (header, nav, footer)
- [ ] Cards composants affichent les donnees
- [ ] Cards IPC affichent le JSON
- [ ] Polling 2s fonctionne
- [ ] Bouton refresh et toggle fonctionnent
- [ ] Tous IDs DOM preserves
- [ ] Verification visuelle approuvee
</verification>

<success_criteria>
- Heritage base.html fonctionnel avec nav coherente
- Sections Composants et IPC en Tailwind avec panel-astro
- Badges status colores et dynamiques
- Zero regression fonctionnelle (polling, refresh, toggle)
- Verification humaine approuvee
</success_criteria>

<output>
After completion, create `.paul/phases/03-system-page-modernization/03-01-SUMMARY.md`
</output>

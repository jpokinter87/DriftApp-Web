---
phase: 02-dashboard-modernization
plan: 03
type: execute
wave: 1
depends_on: ["02-02"]
files_modified:
  - web/templates/dashboard.html
  - web/static/js/dashboard.js
autonomous: false
---

<objective>
## Goal
Introduire Alpine.js comme couche reactive pour les modales (GOTO, Update), les logs temps reel et la visibilite des panels dynamiques, tout en preservant le JS existant (polling, canvas, API calls).

## Purpose
Le dashboard utilise actuellement 1589 lignes de vanilla JS avec manipulation directe du DOM (classList.add/remove('hidden'), createElement, insertBefore). Alpine.js est deja charge via CDN (base.html Phase 1) mais non utilise. Ce plan cree un pont entre le JS existant et Alpine.js pour une migration progressive.

## Output
- `web/templates/dashboard.html` — directives Alpine.js (x-data, x-show, x-for, x-text)
- `web/static/js/dashboard.js` — pont Alpine.store, suppression des manipulations DOM directes pour modales/logs
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md

## Prior Work
@.paul/phases/02-dashboard-modernization/02-02-SUMMARY.md
- Panels avec .panel-astro, separateurs, glow effects
- Tous IDs DOM preserves

## Source Files
@web/templates/dashboard.html — template actuel post-02-02
@web/static/js/dashboard.js — 1589 lignes vanilla JS (polling 1s, canvas, modals, logs, update system)
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Avant modification du template HTML | ○ |

**BLOCKING:** Required skills MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded
</skills>

<acceptance_criteria>

## AC-1: Alpine.js store fonctionnel
```gherkin
Given le dashboard charge
When Alpine.js s'initialise
Then un Alpine.store('dashboard') existe avec les proprietes reactives:
  - gotoModal (objet avec visible, objectName, startPos, targetPos, currentPos, delta, progress)
  - updateModal (objet avec visible, data, progress, error)
  - logs (tableau d'objets {message, type, time})
  - trackingVisible (boolean)
```

## AC-2: Modales GOTO et Update controlees par Alpine.js
```gherkin
Given la modale GOTO ou Update
When le JS declenche l'affichage/masquage
Then la modale utilise x-show lie au store Alpine (pas classList.add/remove('hidden'))
And les animations CSS existantes sont preservees
And le contenu de la modale est toujours mis a jour correctement
```

## AC-3: Logs rendus par Alpine.js
```gherkin
Given la section Journal
When un nouveau log est ajoute
Then le log apparait en haut de la liste (x-for sur store.logs)
And les 50 derniers logs sont conserves
And le format [HH:MM:SS] message est preserve
And les classes de type (info, error, success, warning) sont appliquees
```

## AC-4: Zero regression fonctionnelle
```gherkin
Given les modifications du JS et du template
When le dashboard fonctionne
Then le polling 1s continue de fonctionner
And la boussole canvas se dessine correctement
And les boutons de controle manuel fonctionnent
And le panel Suivi Actif s'affiche/masque correctement
And la recherche d'objet fonctionne
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Creer le store Alpine.js et migrer les modales</name>
  <files>web/static/js/dashboard.js, web/templates/dashboard.html</files>
  <action>
    **Dans dashboard.js**, au debut du fichier (apres les constantes):

    1. Creer le store Alpine.js:
       ```js
       document.addEventListener('alpine:init', () => {
           Alpine.store('dashboard', {
               // GOTO Modal
               gotoModal: {
                   visible: false,
                   objectName: '--',
                   startPos: 0,
                   targetPos: 0,
                   currentPos: 0,
                   delta: 0,
                   progress: 0,
                   progressText: '0%'
               },
               // Update Modal
               updateModal: {
                   visible: false,
                   currentVersion: '--',
                   currentCommit: '--',
                   newCommit: '--',
                   commitsBehind: 0,
                   commitMessages: [],
                   showProgress: false,
                   progressText: '',
                   showError: false,
                   errorText: '',
                   buttonsDisabled: false
               },
               // Logs
               logs: [],
               // Tracking panel
               trackingVisible: false,

               // Methods
               addLog(message, type = 'info') {
                   this.logs.unshift({
                       message,
                       type,
                       time: new Date().toLocaleTimeString()
                   });
                   if (this.logs.length > 50) {
                       this.logs.length = 50;
                   }
               }
           });
       });
       ```

    2. Modifier la fonction `showGotoModal()`:
       - Remplacer les manipulations DOM directes par des mises a jour du store:
         `Alpine.store('dashboard').gotoModal.visible = true;`
         `Alpine.store('dashboard').gotoModal.objectName = objectName || '--';`
         etc.
       - CONSERVER la logique metier (calcul delta, direction chevrons, timestamp)
       - Supprimer: `elements.gotoModal.classList.remove('hidden');`

    3. Modifier `hideGotoModal()`:
       - `Alpine.store('dashboard').gotoModal.visible = false;`
       - Supprimer: `elements.gotoModal.classList.add('hidden');`

    4. Modifier `updateGotoModalPosition()`:
       - Mettre a jour `store.gotoModal.currentPos`, `store.gotoModal.progress`, `store.gotoModal.progressText`
       - Supprimer les getElementById pour les elements de la modale

    5. Modifier `showUpdateModal()`:
       - Transferer les donnees vers `store.updateModal.*`
       - `store.updateModal.visible = true;`

    6. Modifier `hideUpdateModal()`:
       - `store.updateModal.visible = false;`

    7. Modifier `applyUpdate()`:
       - Utiliser le store pour le progress et les erreurs

    8. Modifier la fonction `log()`:
       - Appeler `Alpine.store('dashboard').addLog(message, type)` au lieu de creer des elements DOM

    9. Modifier `updateTrackingDisplay()`:
       - Utiliser `Alpine.store('dashboard').trackingVisible = true/false` au lieu de classList

    **Dans dashboard.html**:

    1. Ajouter `x-data` sur le bloc content principal:
       Remplacer la div grid par:
       `<div x-data class="grid grid-cols-[350px_1fr] gap-4 mb-4 max-lg:grid-cols-1">`

    2. Modal GOTO — remplacer le controle de visibilite:
       - Remplacer `class="goto-modal hidden"` par:
         `class="goto-modal" x-show="$store.dashboard.gotoModal.visible" x-cloak`
       - Ajouter x-text pour les valeurs dynamiques:
         `<span id="goto-modal-object-name" x-text="$store.dashboard.gotoModal.objectName">--</span>`
         `<span id="goto-modal-current-pos" x-text="$store.dashboard.gotoModal.currentPos.toFixed(1) + '°'">--°</span>`
         `<span id="goto-progress-text" x-text="$store.dashboard.gotoModal.progressText">0%</span>`

    3. Modal Update — meme approche:
       - `x-show="$store.dashboard.updateModal.visible" x-cloak`
       - x-text pour les valeurs dynamiques
       - x-show pour progress et error sections

    4. Section Logs — remplacer le contenu statique par x-for:
       ```html
       <div id="logs" class="log-container">
           <template x-for="entry in $store.dashboard.logs" :key="entry.time + entry.message">
               <div class="log-entry" :class="entry.type"
                    x-text="'[' + entry.time + '] ' + entry.message"></div>
           </template>
       </div>
       ```

    5. Panel Suivi Actif — ajouter x-show:
       `x-show="$store.dashboard.trackingVisible" x-cloak`
       (retirer la classe `hidden` du HTML statique — Alpine gere la visibilite)

    6. Ajouter le style x-cloak en haut du template (dans extra_css ou inline):
       `<style>[x-cloak] { display: none !important; }</style>`

    IMPORTANT: Conserver TOUS les IDs existants sur les elements (meme si x-text les remplace, le JS peut encore les referencer).
    IMPORTANT: Ne PAS modifier la logique du canvas (drawCompass, drawStarField, etc.).
    IMPORTANT: Ne PAS modifier la logique de polling (startPolling, updateStatus).
    IMPORTANT: Le store doit etre initialise AVANT DOMContentLoaded (alpine:init se declenche avant).
  </action>
  <verify>
    python -c "
with open('web/templates/dashboard.html') as f:
    content = f.read()
assert 'x-data' in content, 'Missing x-data directive'
assert 'x-show' in content, 'Missing x-show directive'
assert 'x-for' in content or 'x-text' in content, 'Missing Alpine directives'
assert 'x-cloak' in content, 'Missing x-cloak'
assert '\$store.dashboard' in content, 'Missing store reference'

with open('web/static/js/dashboard.js') as f:
    js = f.read()
assert 'Alpine.store' in js, 'Missing Alpine store'
assert 'alpine:init' in js, 'Missing alpine:init event'
print('✓ Alpine.js store et directives presents')
"
  </verify>
  <done>AC-1, AC-2, AC-3 satisfaits: store Alpine.js, modales et logs migres</done>
</task>

<task type="auto">
  <name>Task 2: Nettoyer le JS des references DOM obsoletes pour modales/logs</name>
  <files>web/static/js/dashboard.js</files>
  <action>
    Apres la migration vers le store:

    1. Supprimer les references DOM devenues inutiles dans `const elements`:
       - Retirer les references aux elements des modales qui sont maintenant geres par x-text
       - Garder les references encore necessaires (gotoChevrons pour la logique de direction)

    2. Supprimer `const updateElements` en entier:
       - Toutes les references sont remplacees par le store Alpine

    3. Nettoyer la fonction `log()`:
       - Supprimer la creation d'elements DOM (createElement, insertBefore, while loop)
       - Garder uniquement l'appel au store

    4. Dans `updateTrackingDisplay()`:
       - Remplacer `elements.trackingInfo.classList.remove('hidden')` par le store
       - Garder toute la logique de mise a jour des cartouches position (non migres)

    5. Verifier qu'il n'y a plus de `classList.add('hidden')` ni `classList.remove('hidden')` pour les modales et logs

    IMPORTANT: Ne pas supprimer les IDs des elements dans le HTML (ils servent de reference documentaire et certains sont encore utilises par le JS).
    IMPORTANT: Garder `addLog()` comme alias si elle est appelee par le code tracking (ligne 592).
  </action>
  <verify>
    python -c "
with open('web/static/js/dashboard.js') as f:
    js = f.read()
# Le store doit exister
assert 'Alpine.store' in js, 'Missing Alpine store'
# Les anciennes refs de modal update doivent etre supprimees
assert 'const updateElements' not in js, 'updateElements still exists'
print('✓ JS nettoye, references obsoletes supprimees')
"
  </verify>
  <done>AC-4 satisfait: JS nettoye, zero regression</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Dashboard avec Alpine.js integre:
    - Store reactif pour modales, logs et tracking
    - Modale GOTO controlee par x-show (visible pendant GOTO initial)
    - Modale Update controlee par x-show (visible si mise a jour disponible)
    - Logs rendus par x-for (reactif, 50 max)
    - Panel Suivi Actif avec x-show
  </what-built>
  <how-to-verify>
    1. Lancer: cd web && python manage.py runserver 0.0.0.0:8000
    2. Visiter http://localhost:8000/
    3. Verifier: La page se charge sans erreur console (F12 > Console)
    4. Verifier: Les logs "Interface initialisée" apparaissent dans le Journal
    5. Verifier: La boussole canvas se dessine correctement
    6. Verifier: Tous les boutons sont cliquables (JOG, Continuous, STOP, GOTO)
    7. Verifier: Le motif etoile est toujours visible sur les panels
    8. Verifier: Les separateurs Controle Manuel sont toujours la
    9. Si possible: Tester la recherche d'objet (ex: "Vega")
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- web/templates/base.html (Phase 1)
- web/static/css/tailwind-input.css (Phase 1)
- web/static/css/dashboard.css (Phase 2 Plan 02)
- web/static/img/constellations-pattern.svg (Phase 2 Plan 02)
- web/templates/system.html, web/templates/session.html (Phase 3-4)
- core/, services/ (backend)

## SCOPE LIMITS
- Ce plan migre UNIQUEMENT les modales, logs et visibilite tracking vers Alpine.js
- Le canvas compass reste en vanilla JS (drawCompass, drawStarField, drawTelescope)
- Le polling (startPolling, updateStatus, fetchStatus) reste en vanilla JS
- Les API calls (apiCall, jog, stopMotor, gotoPosition, etc.) restent en vanilla JS
- Les event listeners des boutons restent en vanilla JS
- La logique du countdown timer reste en vanilla JS
- Pas de migration des cartouches position/encodeur (complexite elevee, peu de gain)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] Page se charge sans erreur console
- [ ] Alpine.store('dashboard') accessible dans la console
- [ ] Logs visibles dans le Journal
- [ ] Boussole canvas fonctionnelle
- [ ] Boutons cliquables
- [ ] Tous IDs DOM preserves
- [ ] Verification visuelle approuvee
</verification>

<success_criteria>
- Alpine.js store fonctionnel avec modales, logs et tracking
- Modales controlees par x-show (pas classList)
- Logs rendus par x-for (pas createElement)
- Zero regression fonctionnelle
- Verification humaine approuvee
</success_criteria>

<output>
After completion, create `.paul/phases/02-dashboard-modernization/02-03-SUMMARY.md`
</output>

---
phase: 04-session-page-modernization
plan: 01
type: execute
wave: 1
depends_on: ["03-02"]
files_modified:
  - web/templates/session.html
  - web/static/js/session.js
  - web/session/urls.py
autonomous: false
---

<objective>
## Goal
Migrer la page Session vers base.html avec Tailwind CSS, moderniser le selecteur de session (current/history), les stats cards et le layout general — tout en preservant Chart.js et les tables pour le Plan 02.

## Purpose
La page Session est la derniere page qui ne beneficie pas de base.html. Elle a son propre header, nav, footer, et CSS independant (session.css). Ce plan l'integre dans le systeme de templates partage et modernise le layout et les composants statiques.

## Output
- `web/templates/session.html` — heritage base.html, sections Tailwind, selecteur, stats, placeholders charts/tables
- `web/static/js/session.js` — adapte aux nouvelles classes CSS, Chart.js preserve
- `web/session/urls.py` — extra_context pour active_tab
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md

## Prior Work
@.paul/phases/03-system-page-modernization/03-01-SUMMARY.md
- Pattern inline CSS pour panel-astro/section-title-fire sur pages secondaires
- TemplateView extra_context pour active_tab nav highlighting

## Source Files
@web/templates/session.html — standalone 250+ lignes, header/nav/footer propres
@web/static/js/session.js — 450+ lignes, Chart.js, polling 5s, tab switcher
@web/static/css/session.css — 500+ lignes, variables CSS propres, responsive
@web/session/urls.py — routes API session
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Avant modification du template HTML | ○ |

**BLOCKING:** Required skills MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded
</skills>

<acceptance_criteria>

## AC-1: Heritage base.html fonctionnel
```gherkin
Given la page Session charge
When le navigateur rend la page
Then elle herite de base.html (header, nav, footer partages)
And le tab "Session" est actif dans la nav (surligne ambre)
And le fond etoile panel-astro est visible sur les sections
```

## AC-2: Selecteur de session modernise
```gherkin
Given la page Session charge
When l'utilisateur clique sur "Session en cours" ou "Historique"
Then le bon panel s'affiche (current ou history)
And le style des tabs est coherent avec le theme observatory
And la liste historique affiche les sessions avec objet, date, duree
```

## AC-3: Stats cards modernisees
```gherkin
Given une session active avec des donnees
When les donnees sont recues de l'API
Then les 5 stats cards affichent les valeurs correctes
And la distribution des modes affiche les barres colorees
And le style est coherent avec les cards composants de la page Systeme
```

## AC-4: Layout et sections preserves sans regression
```gherkin
Given les modifications
When la page Session fonctionne
Then le polling 5s continue (current tab)
And les sections Charts, Corrections, GOTO sont presentes (meme si non modernisees)
And Chart.js s'initialise correctement
And aucune erreur console
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Migrer session.html vers base.html et moderniser layout + selecteur + stats</name>
  <files>web/templates/session.html, web/session/urls.py</files>
  <action>
    **Dans session.html**, reecrire completement pour heritage base.html:

    1. `{% extends "base.html" %}` avec blocks: title, extra_css, status_indicator, content, footer_extra, extra_js

    2. Block extra_css — ajouter styles inline:
       - panel-astro et section-title-fire (meme pattern que system.html)
       - Styles specifiques session: selector tabs, stat cards, mode bars
       - Chart wrapper styles (hauteur fixe 250px)
       - Table styles (corrections, goto)
       - NE PAS charger session.css (meme approche que system.css retire en 03-01)

    3. Block status_indicator — indicateur session:
       ```html
       <div class="flex items-center gap-1.5 text-xs font-mono" id="session-status">
           <span class="session-status-dot"></span>
           <span class="status-text text-obs-text-muted" id="session-status-text">--</span>
       </div>
       ```

    4. Block content — sections avec Tailwind:

       **Section Selecteur:**
       - Panel avec panel-astro
       - 2 boutons tabs (Session en cours / Historique) avec classes Tailwind
       - Panel current-session-info avec objet, duree, coords
       - Panel history avec history-list

       **Section Charts:**
       - Panel avec panel-astro, titre section-title-fire
       - Grid 2 colonnes pour canvas#altitude-chart et canvas#azimut-chart
       - Legende 4 items (NORMAL, CRITICAL, CONTINUOUS, Correction)

       **Section Statistiques:**
       - Panel avec panel-astro, titre section-title-fire
       - Grid stats cards (5 cards) avec Tailwind
       - Distribution modes avec barres colorees

       **Section Corrections:**
       - Panel avec panel-astro, titre section-title-fire
       - Table responsive avec scroll

       **Section GOTO:**
       - Panel avec panel-astro, titre section-title-fire
       - Table responsive avec scroll

    5. Block footer_extra — timestamp + auto-refresh toggle (meme pattern que system.html)

    6. Block extra_js — charger Chart.js CDN + session.js

    IMPORTANT: Conserver TOUS les IDs DOM existants (voir liste dans le plan)
    IMPORTANT: Charger Chart.js AVANT session.js
    IMPORTANT: Ne PAS modifier la logique JS — seulement le HTML

    **Dans urls.py:**
    - Ajouter extra_context={'active_tab': 'session'} au TemplateView

    IDs DOM a preserver:
    session-status, session-object, session-duration, session-coords,
    current-session-info, history-panel, history-list,
    altitude-chart, azimut-chart,
    stat-corrections, stat-total-movement, stat-cw, stat-ccw, stat-avg-correction,
    mode-bar-normal, mode-bar-critical, mode-bar-continuous,
    mode-time-normal, mode-time-critical, mode-time-continuous,
    corrections-tbody, goto-tbody, last-update, auto-refresh-toggle
  </action>
  <verify>
    python -c "
with open('web/templates/session.html') as f:
    content = f.read()
assert '{% extends' in content and 'base.html' in content, 'Missing base.html inheritance'
assert 'panel-astro' in content, 'Missing panel-astro'
assert 'altitude-chart' in content, 'Missing chart canvas'
assert 'corrections-tbody' in content, 'Missing corrections table'
assert 'history-list' in content, 'Missing history list'
assert 'stat-corrections' in content, 'Missing stats cards'
assert 'mode-bar-normal' in content, 'Missing mode distribution'
assert 'auto-refresh-toggle' in content, 'Missing auto-refresh'
print('✓ Template session.html migre vers base.html avec tous IDs preserves')
"
  </verify>
  <done>AC-1, AC-2, AC-3 satisfaits: heritage base.html, selecteur, stats modernises</done>
</task>

<task type="auto">
  <name>Task 2: Adapter session.js aux nouvelles classes CSS</name>
  <files>web/static/js/session.js</files>
  <action>
    Adapter les references CSS dans session.js:

    1. updateSessionStatus() — adapter les classes du status dot:
       - Remplacer les anciennes classes par session-status-dot + healthy/error
       - Utiliser les classes definies dans extra_css

    2. switchTab() — verifier que le show/hide fonctionne:
       - Les tabs utilisent data-tab, les panels ont current-session-info / history-panel
       - S'assurer que les classes hidden/flex sont correctement basculees

    3. displayHistory() — adapter le HTML genere:
       - Les history-item doivent utiliser des classes Tailwind au lieu des classes session.css
       - Bouton delete, infos session, style coherent

    4. Chart.js — adapter les couleurs de grille et ticks:
       - Utiliser les couleurs du theme (pas hardcode #333/#a0a0a0)
       - gridColor: 'rgba(74, 61, 46, 0.5)' (obs-border equivalent)
       - tickColor: 'rgba(160, 144, 128, 1)' (obs-text-secondary equivalent)

    5. updateStats() et updateModeDistribution() — verifier les references DOM
       - Ces fonctions utilisent getElementById, pas de classes CSS a changer

    IMPORTANT: NE PAS modifier la logique de polling, fetch, Chart.js data processing
    IMPORTANT: NE PAS modifier les fonctions utilitaires (formatDuration, formatDMS, formatHMS)
    IMPORTANT: Garder intactes updateCharts, updateCorrectionsTable, updateGotoTable
  </action>
  <verify>
    python -c "
with open('web/static/js/session.js') as f:
    js = f.read()
assert 'loadCurrentSession' in js, 'Missing loadCurrentSession'
assert 'initCharts' in js, 'Missing initCharts'
assert 'updateSessionDisplay' in js, 'Missing updateSessionDisplay'
assert 'displayHistory' in js, 'Missing displayHistory'
assert 'formatDuration' in js, 'Missing formatDuration'
assert 'Chart' in js, 'Missing Chart.js usage'
print('✓ session.js adapte, logique preservee')
"
  </verify>
  <done>AC-4 satisfait: JS adapte, Chart.js fonctionnel, zero regression</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Page Session migree vers base.html avec Tailwind:
    - Heritage base.html avec header/nav/footer partages
    - Selecteur session (current/history) modernise
    - Stats cards et distribution modes modernises
    - Charts et tables preserves (modernisation en 04-02)
    - Polling 5s et Chart.js fonctionnels
  </what-built>
  <how-to-verify>
    1. Lancer: cd web && python manage.py runserver 0.0.0.0:8000
    2. Visiter http://localhost:8000/session/
    3. Verifier: La page se charge sans erreur console (F12 > Console)
    4. Verifier: Le header/nav/footer sont partages avec dashboard et systeme
    5. Verifier: Le tab "Session" est surligne en ambre dans la nav
    6. Verifier: Le fond etoile panel-astro est visible
    7. Verifier: Le selecteur current/history fonctionne
    8. Verifier: Les stats cards s'affichent (valeurs ou "--" si pas de session)
    9. Verifier: Les charts s'affichent (vides si pas de session)
    10. Verifier: Les tables corrections/GOTO sont presentes
    11. Verifier: Le toggle auto-refresh fonctionne
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- web/templates/base.html (Phase 1)
- web/static/css/tailwind-input.css (Phase 1)
- web/static/css/dashboard.css (Phase 2)
- web/templates/dashboard.html (Phase 2)
- web/static/js/dashboard.js (Phase 2)
- web/templates/system.html (Phase 3)
- web/static/js/system.js (Phase 3)
- core/, services/ (backend)
- web/session/views.py (backend API)

## SCOPE LIMITS
- Ce plan migre le layout, selecteur et stats — PAS les charts ni tables (Plan 02)
- Les charts Canvas et tables restent fonctionnels mais ne sont pas modernises visuellement
- Pas de modification du backend/API
- Pas d'introduction d'Alpine.js (Plan 02 pour Alpine store si pertinent)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] Page se charge sans erreur console
- [ ] Heritage base.html fonctionnel (header, nav, footer partages)
- [ ] Tab Session actif dans la nav
- [ ] Fond etoile panel-astro visible
- [ ] Selecteur current/history fonctionne
- [ ] Stats cards affichent les donnees
- [ ] Distribution modes affiche les barres
- [ ] Charts s'initialisent (Chart.js)
- [ ] Tables corrections/GOTO presentes
- [ ] Polling 5s fonctionne
- [ ] Auto-refresh toggle fonctionne
- [ ] Verification visuelle approuvee
</verification>

<success_criteria>
- Heritage base.html avec nav coherente
- Selecteur session modernise avec Tailwind
- Stats cards et distribution modes modernises
- Charts et tables fonctionnels (non modernises)
- Zero regression fonctionnelle
- Verification humaine approuvee
</success_criteria>

<output>
After completion, create `.paul/phases/04-session-page-modernization/04-01-SUMMARY.md`
</output>

---
phase: 04-session-page-modernization
plan: 02
type: execute
wave: 1
depends_on: ["04-01"]
files_modified:
  - web/templates/session.html
  - web/static/js/session.js
autonomous: false
---

<objective>
## Goal
Introduire Alpine.js comme couche reactive pour le status de session, le toggle auto-refresh et le selecteur de tabs, en suivant le pattern Alpine.store bridge etabli en Phases 2 et 3.

## Purpose
La page Session utilise actuellement du vanilla JS pour le status indicator, le tab switching et l'auto-refresh toggle. Ce plan cree un Alpine.store('session') pour ces elements reactifs, simplifie les event listeners et aligne la page avec le pattern des autres pages.

## Output
- `web/templates/session.html` — directives Alpine.js (x-data, x-show, x-text, x-bind, x-model)
- `web/static/js/session.js` — pont Alpine.store, simplification des event listeners
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md

## Prior Work
@.paul/phases/04-session-page-modernization/04-01-SUMMARY.md
- Page migree vers base.html avec Tailwind
- Tous IDs DOM preserves, session.css retire
- Chart.js et tables fonctionnels

@.paul/phases/03-system-page-modernization/03-02-SUMMARY.md
- Alpine.store('system') pattern: alpine:init, store updates, x-model toggle
- autoRefresh sync via setInterval polling watching store

## Source Files
@web/templates/session.html — post 04-01, heritage base.html, sections Tailwind
@web/static/js/session.js — 766 lignes, polling 5s, Chart.js, tab switcher
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Avant modification du template HTML | ○ |

**BLOCKING:** Required skills MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded
</skills>

<acceptance_criteria>

## AC-1: Alpine.store('session') fonctionnel
```gherkin
Given la page Session charge
When Alpine.js s'initialise
Then un Alpine.store('session') existe avec:
  - statusClass (string: active/inactive/history/error)
  - statusText (string)
  - autoRefresh (boolean, default true)
  - currentTab (string: current/history)
```

## AC-2: Status indicator et auto-refresh reactifs
```gherkin
Given le store Alpine session
When les donnees de session sont recues (ou 404)
Then le status dot change de couleur via x-bind:class
And le texte status se met a jour via x-text
And le toggle auto-refresh controle le polling via x-model et store
```

## AC-3: Tab switching reactif
```gherkin
Given les tabs Session en cours / Historique
When l'utilisateur clique sur un tab
Then le store.currentTab change
And le panel correspondant s'affiche via x-show
And le tab actif est surligne via x-bind:class
```

## AC-4: Zero regression fonctionnelle
```gherkin
Given les modifications
When la page Session fonctionne
Then le polling 5s continue
And Chart.js s'initialise et se met a jour correctement
And les tables corrections/GOTO se mettent a jour
And la liste historique fonctionne (selection, suppression)
And aucune erreur console (hors 404 normal)
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Creer Alpine.store('session') et migrer status + auto-refresh + tabs</name>
  <files>web/static/js/session.js, web/templates/session.html</files>
  <action>
    **Dans session.js**, au debut du fichier (avant DOMContentLoaded):

    1. Creer le store Alpine.js:
       ```js
       document.addEventListener('alpine:init', () => {
           Alpine.store('session', {
               // Status indicator
               statusClass: '',
               statusText: '--',
               // Auto-refresh
               autoRefresh: true,
               // Tab switching
               currentTab: 'current',
           });
       });
       ```

    2. Modifier `updateSessionStatus()`:
       - Remplacer les assignments className/textContent par le store:
         `Alpine.store('session').statusClass = status;`
         `Alpine.store('session').statusText = text;`
       - Supprimer les querySelector sur .session-status-dot et .status-text

    3. Modifier `initTabSwitcher()` et `switchTab()`:
       - switchTab met a jour le store: `Alpine.store('session').currentTab = tabName;`
       - Retirer les classList.add/remove('active') sur les tabs (gere par x-bind:class)
       - Retirer les classList.add/remove('hidden') sur les panels (gere par x-show)
       - GARDER la logique loadCurrentSession/loadHistory dans switchTab

    4. Modifier `initAutoRefresh()`:
       - Retirer le listener du toggle (x-model le remplace)
       - Garder startRefreshTimer/stopRefreshTimer
       - Ajouter un watcher polling (meme pattern que system.js):
         setInterval pour verifier store.autoRefresh et sync avec timer

    5. Retirer du state global les champs geres par Alpine:
       - state.currentTab → store
       - state.autoRefresh → store
       - GARDER state.refreshTimer, state.altitudeChart, state.azimutChart,
         state.currentSessionData, state.historyLoaded

    **Dans session.html**:

    1. Status indicator — migrer vers Alpine:
       ```html
       <div class="flex items-center gap-1.5 text-xs font-mono" id="session-status" x-data>
           <span class="session-status-dot"
                 :class="$store.session.statusClass"></span>
           <span class="status-text text-obs-text-muted"
                 x-text="$store.session.statusText">--</span>
       </div>
       ```

    2. Selector tabs — migrer vers Alpine:
       ```html
       <button class="selector-tab" data-tab="current"
               :class="{ 'active': $store.session.currentTab === 'current' }"
               @click="$store.session.currentTab = 'current'">
       ```
       (idem pour history tab)
       Ajouter un x-effect ou watcher dans le JS pour reagir aux changements de tab

    3. Panels current/history — x-show:
       ```html
       <div id="current-session-info" x-data
            x-show="$store.session.currentTab === 'current'">
       ```
       ```html
       <div id="history-panel" x-data
            x-show="$store.session.currentTab === 'history'"
            class="max-h-72 overflow-y-auto">
       ```
       Retirer la classe "hidden" initiale (x-show gere la visibilite)

    4. Auto-refresh toggle — x-model:
       ```html
       <input type="checkbox" id="auto-refresh-toggle"
              x-data x-model="$store.session.autoRefresh"
              class="cursor-pointer accent-accent-amber">
       ```

    IMPORTANT: Conserver TOUS les IDs existants
    IMPORTANT: Ne PAS modifier la logique Chart.js, tables, history
    IMPORTANT: Le store doit etre initialise AVANT DOMContentLoaded
  </action>
  <verify>
    python -c "
with open('web/templates/session.html') as f:
    content = f.read()
assert 'x-text' in content or 'x-bind' in content or ':class' in content, 'Missing Alpine directives'
assert '\$store.session' in content, 'Missing store reference'
assert 'x-show' in content, 'Missing x-show for tab panels'
assert 'x-model' in content, 'Missing x-model for auto-refresh'

with open('web/static/js/session.js') as f:
    js = f.read()
assert 'Alpine.store' in js, 'Missing Alpine store'
assert 'alpine:init' in js, 'Missing alpine:init event'
assert 'loadCurrentSession' in js, 'Missing loadCurrentSession (regression)'
assert 'initCharts' in js, 'Missing initCharts (regression)'
print('✓ Alpine.js store et directives integres')
"
  </verify>
  <done>AC-1, AC-2, AC-3 satisfaits: store Alpine avec status, auto-refresh et tabs reactifs</done>
</task>

<task type="auto">
  <name>Task 2: Nettoyer les references DOM obsoletes et syncer tab switching avec store</name>
  <files>web/static/js/session.js</files>
  <action>
    Apres la migration vers le store:

    1. S'assurer que switchTab() appelle bien loadCurrentSession ou loadHistory
       selon la valeur du tab — la logique metier doit rester:
       - current tab: loadCurrentSession()
       - history tab: loadHistory() si pas deja charge

    2. Ajouter un watcher pour reagir aux changements de tab depuis le HTML:
       - Le @click dans le HTML met a jour le store
       - Le JS doit observer le store pour declencher les fetches
       - Pattern: setInterval checkant store.currentTab vs derniere valeur connue
       - OU: garder le @click qui appelle aussi switchTab() via onclick

    3. Verifier qu'aucune reference a un element supprime n'est utilisee

    IMPORTANT: Ne pas supprimer les fonctions — uniquement simplifier les event listeners
    IMPORTANT: Garder Chart.js, tables, history intacts
  </action>
  <verify>
    python -c "
with open('web/static/js/session.js') as f:
    js = f.read()
assert 'Alpine.store' in js, 'Missing Alpine store'
assert 'loadCurrentSession' in js, 'Missing loadCurrentSession'
assert 'initCharts' in js, 'Missing initCharts'
assert 'updateCharts' in js, 'Missing updateCharts'
assert 'displayHistory' in js, 'Missing displayHistory'
assert 'formatDuration' in js, 'Missing formatDuration'
print('✓ JS nettoye, logique preservee')
"
  </verify>
  <done>AC-4 satisfait: JS nettoye, zero regression</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Page Session avec Alpine.js integre:
    - Store reactif pour status, auto-refresh et tab switching
    - Toggle auto-refresh controle par x-model
    - Tabs current/history reactifs via x-show et x-bind:class
    - Polling 5s, Chart.js et tables preserves
  </what-built>
  <how-to-verify>
    1. Lancer: cd web && python manage.py runserver 0.0.0.0:8000
    2. Visiter http://localhost:8000/session/
    3. Verifier: La page se charge sans erreur console (hors 404 normal)
    4. Verifier: Le status indicator se met a jour
    5. Verifier: Cliquer sur "Historique" affiche la liste historique
    6. Verifier: Cliquer sur "Session en cours" revient au panel current
    7. Verifier: Decocher auto-refresh arrete le polling (F12 > Network)
    8. Verifier: Recocher auto-refresh reprend le polling
    9. Verifier: Les charts s'affichent (vides si pas de session)
    10. Verifier: Les tables corrections/GOTO sont presentes
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- web/templates/base.html (Phase 1)
- web/static/css/tailwind-input.css (Phase 1)
- web/static/css/dashboard.css (Phase 2)
- web/templates/dashboard.html (Phase 2)
- web/static/js/dashboard.js (Phase 2)
- web/templates/system.html (Phase 3)
- web/static/js/system.js (Phase 3)
- core/, services/ (backend)
- web/session/views.py (backend API)

## SCOPE LIMITS
- Ce plan migre UNIQUEMENT status, auto-refresh et tabs vers Alpine.js
- Chart.js reste en vanilla JS (pas de gain reactif)
- Tables corrections/GOTO restent en vanilla JS (innerHTML genere)
- Pas de modification du backend/API

</boundaries>

<verification>
Before declaring plan complete:
- [ ] Page se charge sans erreur console (hors 404 normal)
- [ ] Alpine.store('session') accessible dans la console
- [ ] Status indicator reactif
- [ ] Tab switching reactif (x-show)
- [ ] Toggle auto-refresh fonctionne (x-model)
- [ ] Polling 5s fonctionnel
- [ ] Chart.js fonctionnel
- [ ] Tables fonctionnelles
- [ ] Historique fonctionnel (selection, suppression)
- [ ] Verification visuelle approuvee
</verification>

<success_criteria>
- Alpine.store('session') fonctionnel avec status, auto-refresh et tabs
- Toggle auto-refresh controle par x-model
- Tab switching reactif via x-show
- Zero regression fonctionnelle
- Verification humaine approuvee
</success_criteria>

<output>
After completion, create `.paul/phases/04-session-page-modernization/04-02-SUMMARY.md`
</output>

---
phase: 01-code-review
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/01-code-review/reports/dry-report.md
  - .planning/phases/01-code-review/reports/docstring-report.md
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "Le code duplique est identifie avec estimation d'effort"
    - "Les fonctions publiques sans docstrings sont listees par module"
    - "Les fonctions publiques sans type hints sont identifiees"
  artifacts:
    - path: ".planning/phases/01-code-review/reports/dry-report.md"
      provides: "Rapport des violations DRY"
      contains: "| Pattern |"
    - path: ".planning/phases/01-code-review/reports/docstring-report.md"
      provides: "Rapport de couverture documentation"
      contains: "| Module | Coverage |"
  key_links:
    - from: "interrogate output"
      to: "docstring-report.md"
      via: "analyse coverage"
      pattern: "docstring|coverage"
---

<objective>
Identifier les violations DRY (code duplique) et analyser la couverture de documentation (docstrings, type hints).

Purpose: REVIEW-03 et REVIEW-04 exigent d'identifier le code duplique et les lacunes de documentation. Ce plan utilise interrogate pour les docstrings et une analyse manuelle par grep pour DRY.
Output: dry-report.md et docstring-report.md
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-code-review/01-RESEARCH.md

# Key modules for DRY analysis
@core/config/config.py
@core/utils/angle_utils.py
@services/ipc_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyser violations DRY par patterns</name>
  <files>.planning/phases/01-code-review/reports/dry-report.md</files>
  <action>
1. **Rechercher les patterns de duplication courants:**
   ```bash
   cd /home/jp/PythonProject/Dome_web_v4_6

   # Configuration loading patterns
   grep -rn "json.load" core/ services/ --include="*.py"
   grep -rn "with open.*config" core/ services/ --include="*.py"

   # Angle normalization
   grep -rn "normalize" core/ services/ --include="*.py"
   grep -rn "% 360" core/ services/ --include="*.py"

   # Logging setup
   grep -rn "getLogger" core/ services/ --include="*.py"
   grep -rn "logging.getLogger" core/ services/ --include="*.py"

   # IPC file paths
   grep -rn "/dev/shm/" core/ services/ --include="*.py"

   # Error message formatting
   grep -rn "logger.error" core/ services/ --include="*.py" | head -20
   ```

2. **Classifier les duplications:**
   - Acceptable: Logging setup (pattern standard)
   - A factoriser: Chemins IPC hardcodes
   - A evaluer: Patterns de normalization

3. **Estimer l'effort de correction:**
   - Trivial (< 1h): Extraire constante
   - Facile (1-2h): Creer fonction utilitaire
   - Moyen (2-4h): Refactoring module

4. **Structure du rapport:**
```markdown
# DRY Violations Report

## Summary
- Total duplicate patterns found: X
- Effort estimation: Y hours total

## Patterns Found

### Critical (exact duplicates > 10 lines)
| Pattern | Occurrences | Files | Effort | Recommendation |
|---------|-------------|-------|--------|----------------|

### Medium (repeated logic 3+ times)
| Pattern | Occurrences | Files | Effort | Recommendation |
|---------|-------------|-------|--------|----------------|

### Acceptable (intentional duplication)
| Pattern | Reason |
|---------|--------|

## Refactoring Recommendations
[Prioritized by effort/impact ratio]
```

5. Ne pas inclure les patterns de test (tests/) car la duplication y est souvent intentionnelle.
  </action>
  <verify>Les patterns principaux sont identifies avec occurrences et fichiers</verify>
  <done>dry-report.md complet avec estimation d'effort</done>
</task>

<task type="auto">
  <name>Task 2: Analyser couverture docstrings et type hints</name>
  <files>.planning/phases/01-code-review/reports/docstring-report.md, pyproject.toml</files>
  <action>
1. **Installer interrogate:**
   ```bash
   cd /home/jp/PythonProject/Dome_web_v4_6
   uv add --dev interrogate
   ```

2. **Executer interrogate sur core/ et services/:**
   ```bash
   # Summary
   uv run interrogate core/ services/ -v

   # Detailed avec exclusions standard
   uv run interrogate core/ services/ -vv \
       --ignore-init-module \
       --ignore-magic \
       --ignore-private
   ```

3. **Verifier type hints avec grep:**
   ```bash
   # Fonctions sans type hints (approximation)
   grep -rn "def " core/ services/ --include="*.py" | grep -v "->" | head -30

   # Fonctions publiques specifiquement
   grep -rn "^    def [a-z]" core/ services/ --include="*.py" | grep -v "->" | head -30
   ```

4. **Structure du rapport:**
```markdown
# Documentation Coverage Report

## Summary
- Overall docstring coverage: X%
- Type hint coverage (estimated): Y%

## By Module

| Module | Docstring % | Functions Missing | Priority |
|--------|-------------|-------------------|----------|
| core/hardware/moteur.py | 45% | list... | High |
| core/tracking/tracker.py | 60% | list... | Medium |
| ... | ... | ... | ... |

## Functions Missing Docstrings (Public API)

### High Priority (public interfaces)
| Module | Function | Line |
|--------|----------|------|

### Medium Priority (internal but complex)
| Module | Function | Line |
|--------|----------|------|

## Functions Missing Type Hints

### Public API (should have)
| Module | Function | Line |
|--------|----------|------|

## Recommendations
1. Focus on public API functions first
2. Add type hints to functions with complex signatures
3. Docstring template to use:
   ```python
   def function(arg: Type) -> ReturnType:
       \"\"\"
       Brief description.

       Args:
           arg: Description

       Returns:
           Description
       \"\"\"
   ```
```

5. Prioriser les fonctions publiques (sans underscore prefix) dans core/hardware/ et core/tracking/.
  </action>
  <verify>interrogate execute et produit un pourcentage de couverture</verify>
  <done>docstring-report.md avec couverture par module et liste des manquants</done>
</task>

</tasks>

<verification>
- [ ] interrogate installe et fonctionne
- [ ] dry-report.md contient les patterns dupliques avec occurrences
- [ ] docstring-report.md contient la couverture par module
- [ ] Les fonctions publiques sans documentation sont listees
- [ ] L'effort de correction DRY est estime
</verification>

<success_criteria>
1. dry-report.md existe avec patterns et estimation d'effort
2. docstring-report.md existe avec couverture par module
3. Les fonctions publiques sans docstrings sont listees par priorite
4. Les fonctions sans type hints sont identifiees
</success_criteria>

<output>
After completion, create `.planning/phases/01-code-review/01-03-SUMMARY.md`
</output>

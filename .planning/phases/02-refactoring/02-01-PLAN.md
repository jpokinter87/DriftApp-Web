---
phase: 02-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - core/exceptions.py
  - core/config/config.py
  - core/observatoire/catalogue.py
  - core/tracking/abaque_manager.py
  - core/tracking/tracker.py
  - core/tracking/tracking_goto_mixin.py
  - core/hardware/daemon_encoder_reader.py
  - tests/test_exceptions.py
autonomous: true

must_haves:
  truths:
    - "Custom exceptions exist for Motor, Encoder, Abaque, IPC, Config errors"
    - "15 bare exceptions in core/ are replaced with specific exception types"
    - "Exception chaining preserved (from e) for debugging"
    - "All 315+ existing tests pass after changes"
  artifacts:
    - path: "core/exceptions.py"
      provides: "DriftAppError base + 5 specific exception classes"
      contains: "class DriftAppError"
    - path: "tests/test_exceptions.py"
      provides: "Tests for exception attributes and hierarchy"
      min_lines: 30
  key_links:
    - from: "core/tracking/tracker.py"
      to: "core/exceptions.py"
      via: "import EncoderError"
      pattern: "from core.exceptions import"
    - from: "core/tracking/tracking_goto_mixin.py"
      to: "core/exceptions.py"
      via: "except EncoderError"
      pattern: "except EncoderError"
---

<objective>
Create a custom exception hierarchy for DriftApp and replace 15 bare exceptions in core/ with specific exception types.

Purpose: Better error debugging, typed exception catching, and proper exception chaining (B904 fix).
Output: core/exceptions.py module, updated core/ files with specific exceptions, test coverage for new exceptions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-refactoring/02-CONTEXT.md
@.planning/phases/02-refactoring/02-RESEARCH.md
@.planning/phases/01-code-review/reports/exceptions-report.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create exception hierarchy module</name>
  <files>core/exceptions.py, tests/test_exceptions.py</files>
  <action>
Create `core/exceptions.py` with the following exception classes (based on 02-RESEARCH.md architecture):

1. `DriftAppError(Exception)` - Base exception for all DriftApp errors
2. `MotorError(DriftAppError)` - Motor control failure with attributes: pin, delay, operation
3. `EncoderError(DriftAppError)` - Encoder communication failure with attributes: daemon_path, timeout_ms
4. `AbaqueError(DriftAppError)` - Abaque loading/interpolation failure with attributes: file_path, altitude, azimut
5. `IPCError(DriftAppError)` - IPC communication failure with attributes: file_path, operation
6. `ConfigError(DriftAppError)` - Configuration loading failure with attributes: config_path, key

Each exception should:
- Have a descriptive docstring
- Accept `message` as first positional arg
- Accept contextual attributes as keyword-only args with defaults to None
- Store attributes as instance properties

Create `tests/test_exceptions.py` with:
- Test that each exception inherits from DriftAppError
- Test that attributes are accessible
- Test that message is preserved
- Test exception chaining with `from e`
  </action>
  <verify>
Run: `uv run pytest tests/test_exceptions.py -v`
All tests pass.
  </verify>
  <done>
core/exceptions.py exists with 6 exception classes.
tests/test_exceptions.py exists with passing tests for hierarchy and attributes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace 15 bare exceptions in core/</name>
  <files>
core/config/config.py
core/observatoire/catalogue.py
core/tracking/abaque_manager.py
core/tracking/tracker.py
core/tracking/tracking_goto_mixin.py
core/hardware/daemon_encoder_reader.py
  </files>
  <action>
Replace each `except Exception:` with specific exception types as documented in exceptions-report.md:

**core/config/config.py:55**
- Change: `except Exception:` to `except (json.JSONDecodeError, OSError):`

**core/observatoire/catalogue.py (3 locations)**
- Line 74: `except Exception:` to `except (json.JSONDecodeError, OSError):`
- Line 91: `except Exception:` to `except OSError:`
- Line 181: `except Exception:` to `except (ConnectionError, TimeoutError, requests.exceptions.RequestException):`
  - Import requests.exceptions if not present

**core/tracking/abaque_manager.py (3 locations)**
- Line 127: `except Exception:` to `except (FileNotFoundError, ValueError, KeyError):`
- Line 251: `except Exception:` to `except (ValueError, IndexError):`
- Line 351: `except Exception:` to `except OSError:`

**core/tracking/tracker.py (3 locations)**
- Line 120: `except Exception:` to `except EncoderError:`
- Line 258: `except Exception:` to `except EncoderError:`
- Line 432: `except Exception:` to `except (ImportError, OSError):`
- Add import: `from core.exceptions import EncoderError`

**core/tracking/tracking_goto_mixin.py (4 locations)**
- Line 99: `except Exception:` to `except EncoderError:`
- Line 160: `except Exception:` to `except EncoderError:`
- Line 218: `except Exception:` to `except EncoderError:`
- Line 232: `except Exception:` to `except (EncoderError, MotorError):`
- Add import: `from core.exceptions import EncoderError, MotorError`

**core/hardware/daemon_encoder_reader.py:142 (B904 fix)**
- Change: `raise RuntimeError(f"Erreur lecture demon: {e}")`
- To: `raise EncoderError(f"Erreur lecture demon: {e}", daemon_path=str(self.daemon_path)) from e`
- Add import: `from core.exceptions import EncoderError`

Important: Use `from e` for exception chaining where catching and re-raising (B904 fix).
  </action>
  <verify>
Run: `uv run pytest -v` (all 315+ tests)
Run: `uv run ruff check core/ --select=E722,BLE001,B904` should show reduced violations in core/
  </verify>
  <done>
15 bare exceptions replaced with specific types.
B904 violation fixed with proper exception chaining.
All 315+ tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Commit and document changes</name>
  <files>.planning/phases/02-refactoring/CHANGELOG.md</files>
  <action>
Create `.planning/phases/02-refactoring/CHANGELOG.md` documenting:

```markdown
# Phase 2 Refactoring Changelog

## [Unreleased]

### Added
- `core/exceptions.py`: Custom exception hierarchy (DriftAppError, MotorError, EncoderError, AbaqueError, IPCError, ConfigError)
- `tests/test_exceptions.py`: Tests for exception classes

### Changed
- `core/config/config.py`: Replaced bare exception with (JSONDecodeError, OSError)
- `core/observatoire/catalogue.py`: Replaced 3 bare exceptions with specific types
- `core/tracking/abaque_manager.py`: Replaced 3 bare exceptions with specific types
- `core/tracking/tracker.py`: Replaced 3 bare exceptions with EncoderError
- `core/tracking/tracking_goto_mixin.py`: Replaced 4 bare exceptions with EncoderError/MotorError
- `core/hardware/daemon_encoder_reader.py`: Fixed B904 with exception chaining
```

Then commit with message:
```
fix(02-01): create exception hierarchy and fix 15 bare exceptions

- Add core/exceptions.py with DriftAppError base + 5 specific classes
- Replace 15 except Exception: with specific types in core/
- Fix B904: add exception chaining with 'from e'
- Add tests for exception attributes and hierarchy

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```
  </action>
  <verify>
Run: `git log -1 --oneline` shows the commit
CHANGELOG.md exists with documented changes
  </verify>
  <done>
Changes committed with descriptive message.
CHANGELOG.md documents all exception-related changes.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest -v` - All 315+ tests pass
2. `uv run ruff check core/ --select=BLE001` - Reduced violations (only intentional ones remain)
3. `python -c "from core.exceptions import DriftAppError, MotorError, EncoderError"` - Imports work
4. Exception hierarchy is correct: `issubclass(EncoderError, DriftAppError)` returns True
</verification>

<success_criteria>
- core/exceptions.py exists with 6 exception classes
- 15 bare exceptions in core/ replaced with specific types
- B904 violation fixed (exception chaining)
- All 315+ existing tests pass
- CHANGELOG.md documents changes
- Commit created with descriptive message
</success_criteria>

<output>
After completion, create `.planning/phases/02-refactoring/02-01-SUMMARY.md`
</output>

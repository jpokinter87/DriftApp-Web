---
phase: 02-refactoring
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - core/config/config.py
  - core/hardware/daemon_encoder_reader.py
  - core/hardware/encoder_reader.py
  - core/hardware/hardware_detector.py
  - core/hardware/moteur.py
  - core/hardware/feedback_controller.py
  - core/hardware/moteur_simule.py
  - core/tracking/abaque_manager.py
  - core/tracking/tracker.py
  - core/tracking/tracking_state_mixin.py
  - core/tracking/tracking_corrections_mixin.py
  - core/tracking/adaptive_tracking.py
  - core/observatoire/calculations.py
  - core/observatoire/ephemerides.py
  - services/ipc_manager.py
  - services/command_handlers.py
autonomous: true

must_haves:
  truths:
    - "IPC file paths are defined once in core/config/config.py"
    - "All files use imported IPC constants instead of hardcoded paths"
    - "All angle % 360 operations use normalize_angle_360() utility"
    - "All 315+ existing tests pass after changes"
  artifacts:
    - path: "core/config/config.py"
      provides: "IPC_BASE, IPC_MOTOR_COMMAND, IPC_MOTOR_STATUS, IPC_ENCODER_POSITION constants"
      contains: "IPC_MOTOR_COMMAND"
  key_links:
    - from: "services/ipc_manager.py"
      to: "core/config/config.py"
      via: "import IPC constants"
      pattern: "from core.config.config import IPC_"
    - from: "core/hardware/moteur.py"
      to: "core/utils/angle_utils.py"
      via: "import normalize_angle_360"
      pattern: "from core.utils.angle_utils import normalize_angle_360"
---

<objective>
Centralize IPC file paths and consistently use normalize_angle_360() for all angle normalization.

Purpose: Eliminate code duplication (DRY principle) - IPC paths defined 6x, angle normalization inline 25+ times.
Output: Single source of truth for IPC paths, consistent angle normalization across codebase.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-refactoring/02-CONTEXT.md
@.planning/phases/02-refactoring/02-RESEARCH.md
@.planning/phases/01-code-review/reports/dry-report.md
@.planning/phases/02-refactoring/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Centralize IPC paths in config.py</name>
  <files>
core/config/config.py
core/hardware/daemon_encoder_reader.py
core/hardware/encoder_reader.py
core/hardware/hardware_detector.py
services/ipc_manager.py
  </files>
  <action>
**Step 1: Add IPC constants to core/config/config.py**

Add near the top of the file (after imports, before other constants):
```python
from pathlib import Path

# IPC file paths (centralized - single source of truth)
IPC_BASE = Path("/dev/shm")
IPC_MOTOR_COMMAND = IPC_BASE / "motor_command.json"
IPC_MOTOR_STATUS = IPC_BASE / "motor_status.json"
IPC_ENCODER_POSITION = IPC_BASE / "ems22_position.json"
```

**Step 2: Update files to use constants**

In `core/hardware/daemon_encoder_reader.py`:
- Remove: `DAEMON_JSON = Path("/dev/shm/ems22_position.json")`
- Add import: `from core.config.config import IPC_ENCODER_POSITION`
- Replace usage: `DAEMON_JSON` -> `IPC_ENCODER_POSITION`

In `core/hardware/encoder_reader.py`:
- Remove: `SHARED_FILE = Path("/dev/shm/ems22_position.json")`
- Add import: `from core.config.config import IPC_ENCODER_POSITION`
- Replace usage: `SHARED_FILE` -> `IPC_ENCODER_POSITION`

In `core/hardware/hardware_detector.py`:
- Remove: `daemon_json = Path("/dev/shm/ems22_position.json")` (around line 120)
- Add import: `from core.config.config import IPC_ENCODER_POSITION`
- Replace local variable with constant

In `services/ipc_manager.py`:
- Remove: `COMMAND_FILE = Path("/dev/shm/motor_command.json")`
- Remove: `STATUS_FILE = Path("/dev/shm/motor_status.json")`
- Remove: `ENCODER_FILE = Path("/dev/shm/ems22_position.json")`
- Add import: `from core.config.config import IPC_MOTOR_COMMAND, IPC_MOTOR_STATUS, IPC_ENCODER_POSITION`
- Replace: `COMMAND_FILE` -> `IPC_MOTOR_COMMAND`
- Replace: `STATUS_FILE` -> `IPC_MOTOR_STATUS`
- Replace: `ENCODER_FILE` -> `IPC_ENCODER_POSITION`

Note: Do NOT modify scripts/diagnostics/ or ems22d_calibrated.py - those are intentionally standalone.
  </action>
  <verify>
Run: `uv run pytest tests/test_ipc_manager.py tests/test_config.py -v`
Run: `python -c "from core.config.config import IPC_MOTOR_COMMAND; print(IPC_MOTOR_COMMAND)"`
Output should be: /dev/shm/motor_command.json
  </verify>
  <done>
IPC paths defined once in core/config/config.py.
4 files updated to import and use centralized constants.
No hardcoded IPC paths in core/ or services/ (except intentional standalone scripts).
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace inline % 360 with normalize_angle_360()</name>
  <files>
core/hardware/moteur.py
core/hardware/feedback_controller.py
core/hardware/moteur_simule.py
core/hardware/daemon_encoder_reader.py
core/tracking/abaque_manager.py
core/tracking/tracker.py
core/tracking/tracking_state_mixin.py
core/tracking/tracking_corrections_mixin.py
core/tracking/adaptive_tracking.py
core/observatoire/calculations.py
core/observatoire/ephemerides.py
services/command_handlers.py
  </files>
  <action>
For each file, add import (if not present):
```python
from core.utils.angle_utils import normalize_angle_360
```

Then replace all inline `x % 360` patterns with `normalize_angle_360(x)`:

**core/hardware/moteur.py** (2 occurrences around lines 330-331):
- `position_cible_deg % 360` -> `normalize_angle_360(position_cible_deg)`
- `position_actuelle_deg % 360` -> `normalize_angle_360(position_actuelle_deg)`

**core/hardware/feedback_controller.py** (1 occurrence around line 532):
- `(position_actuelle + delta_deg) % 360` -> `normalize_angle_360(position_actuelle + delta_deg)`

**core/hardware/moteur_simule.py** (5 occurrences):
- Search for `% 360` and replace each with `normalize_angle_360()` call

**core/hardware/daemon_encoder_reader.py** (1 occurrence):
- Find `% 360` and replace

**core/tracking/abaque_manager.py** (2 occurrences):
- Replace inline % 360

**core/tracking/tracker.py** (3 occurrences):
- Replace inline % 360

**core/tracking/tracking_state_mixin.py** (2 occurrences):
- Replace inline % 360

**core/tracking/tracking_corrections_mixin.py** (2 occurrences):
- Replace inline % 360

**core/tracking/adaptive_tracking.py** (2 occurrences):
- Replace inline % 360

**core/observatoire/calculations.py** (2 occurrences):
- Replace inline % 360

**core/observatoire/ephemerides.py** (3 occurrences):
- Replace inline % 360

**services/command_handlers.py** (3 occurrences):
- Replace inline % 360

Use grep to find all: `grep -rn "% 360" core/ services/ --include="*.py"`
Verify no inline % 360 remains (except in angle_utils.py itself).
  </action>
  <verify>
Run: `grep -rn "% 360" core/ services/ --include="*.py" | grep -v angle_utils.py | wc -l`
Should return 0 (no remaining inline % 360).

Run: `uv run pytest -v` (all tests pass)
  </verify>
  <done>
All 25+ inline % 360 replaced with normalize_angle_360() calls.
Consistent angle normalization across entire codebase.
All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Commit DRY changes</name>
  <files>.planning/phases/02-refactoring/CHANGELOG.md</files>
  <action>
Update `.planning/phases/02-refactoring/CHANGELOG.md` to add:

```markdown
### Changed (DRY)
- `core/config/config.py`: Added IPC_BASE, IPC_MOTOR_COMMAND, IPC_MOTOR_STATUS, IPC_ENCODER_POSITION constants
- `core/hardware/daemon_encoder_reader.py`: Use centralized IPC path + normalize_angle_360()
- `core/hardware/encoder_reader.py`: Use centralized IPC path
- `core/hardware/hardware_detector.py`: Use centralized IPC path
- `services/ipc_manager.py`: Use centralized IPC paths
- 12 files: Replaced inline % 360 with normalize_angle_360() (25+ occurrences)
```

Then commit with message:
```
refactor(02-02): centralize IPC paths and angle normalization (DRY)

- Add IPC_MOTOR_COMMAND, IPC_MOTOR_STATUS, IPC_ENCODER_POSITION to config
- Update 4 files to use centralized IPC constants
- Replace 25+ inline % 360 with normalize_angle_360() in 12 files
- Consistent usage of core/utils/angle_utils utility

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```
  </action>
  <verify>
Run: `git log -1 --oneline` shows the DRY commit
CHANGELOG.md updated with DRY changes
  </verify>
  <done>
DRY changes committed.
CHANGELOG.md documents IPC and angle normalization changes.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "/dev/shm" core/ services/ --include="*.py" | grep -v config.py` - Only config.py defines paths
2. `grep -rn "% 360" core/ services/ --include="*.py" | grep -v angle_utils.py` - No inline % 360 remains
3. `uv run pytest -v` - All 315+ tests pass
4. `python -c "from core.config.config import IPC_MOTOR_COMMAND"` - Import works
</verification>

<success_criteria>
- IPC paths defined exactly once in core/config/config.py
- All 4 consuming files use imported constants
- All 25+ inline % 360 replaced with normalize_angle_360()
- All 315+ existing tests pass
- CHANGELOG.md documents DRY changes
- Commit created with descriptive message
</success_criteria>

<output>
After completion, create `.planning/phases/02-refactoring/02-02-SUMMARY.md`
</output>
